apiVersion: 2019-12-01
location: eastus
name: lingolou
properties:
  imageRegistryCredentials:
  - server: lingolou.azurecr.io
    username: lingolou
    password: ${ACR_PASSWORD}
  containers:
  - name: app
    properties:
      image: lingolou.azurecr.io/lingolou-app:latest
      resources:
        requests:
          cpu: 1
          memoryInGb: 1.5
      ports:
      - port: 8000
      environmentVariables:
      - name: DATABASE_URL
        value: sqlite:///./data/lingolou.db
      - name: REDIS_URL
        value: redis://localhost:6379/0
      - name: SESSION_SECRET_KEY
        secureValue: ${SESSION_SECRET_KEY}
      - name: OPENAI_API_KEY
        secureValue: ${OPENAI_API_KEY}
      - name: ELEVENLABS_API_KEY
        secureValue: ${ELEVENLABS_API_KEY}
      - name: GOOGLE_CLIENT_ID
        value: ${GOOGLE_CLIENT_ID}
      - name: GOOGLE_CLIENT_SECRET
        secureValue: ${GOOGLE_CLIENT_SECRET}
      - name: FRONTEND_URL
        value: ${FRONTEND_URL}
      - name: CORS_ORIGINS
        value: ${CORS_ORIGINS}
      - name: STORAGE_BACKEND
        value: s3
      - name: S3_BUCKET
        value: ${S3_BUCKET}
      - name: S3_ENDPOINT_URL
        value: ${S3_ENDPOINT_URL}
      - name: S3_PREFIX
        value: audio
      - name: AWS_ACCESS_KEY_ID
        secureValue: ${AWS_ACCESS_KEY_ID}
      - name: AWS_SECRET_ACCESS_KEY
        secureValue: ${AWS_SECRET_ACCESS_KEY}
      volumeMounts:
      - name: data
        mountPath: /app/data
  - name: redis
    properties:
      image: lingolou.azurecr.io/redis:7-alpine
      command:
      - redis-server
      - --dir
      - /data
      - --appendonly
      - "yes"
      resources:
        requests:
          cpu: 0.5
          memoryInGb: 0.5
      ports: []
      volumeMounts:
      - name: redis-data
        mountPath: /data
  osType: Linux
  ipAddress:
    type: Public
    dnsNameLabel: lingolou
    ports:
    - protocol: tcp
      port: 8000
  volumes:
  - name: data
    azureFile:
      shareName: lingolou-data
      storageAccountName: ${STORAGE_ACCOUNT_NAME}
      storageAccountKey: ${STORAGE_ACCOUNT_KEY}
  - name: redis-data
    azureFile:
      shareName: lingolou-redis
      storageAccountName: ${STORAGE_ACCOUNT_NAME}
      storageAccountKey: ${STORAGE_ACCOUNT_KEY}
type: Microsoft.ContainerInstance/containerGroups
